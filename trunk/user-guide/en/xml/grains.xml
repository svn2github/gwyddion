<?xml version='1.0' encoding='utf-8'?>
<!-- @(#) $Id$ -->
<!DOCTYPE book PUBLIC '-//OASIS//DTD DocBook XML V4.5//EN'
               'http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd'>
<sect1 id='grain-analysis' xmlns:xi='http://www.w3.org/2001/XInclude'>
  <title>Grain Analysis</title>
  <indexterm><primary>grain marking</primary></indexterm>
  <para>
    There are several grain-related algorithms implemented in Gwyddion. First
    of all, simple thresholding algorithms can be used (height, slope or
    curvature thresholding). These procedures can be very efficient namely
    within particle analysis (to mark particles located on flat surface).
  </para>
  <para id='grain-threshold'>
    <indexterm>
      <primary>grain marking</primary>
      <secondary>threshold</secondary>
    </indexterm>
    Thresholding methods can be accessed within Gwyddion as
    <menuchoice>
      <guimenu>Data Process</guimenu>
      <guisubmenu>Grains</guisubmenu>
      <guimenuitem>Mark by Threshold</guimenuitem>
    </menuchoice>.
    Height, slope and curvature thresholding is implemented within this module.
    The results of each individual thresholding methods can be merged together
    using several operators.
  </para>
  <para id='grain-threshold-otsu'>
    <indexterm>
      <primary>grain marking</primary>
      <secondary>threshold</secondary>
      <tertiary>Otsu's method</tertiary>
    </indexterm>
    The automated Otsu's thresholding method is available as
    <menuchoice>
      <guimenu>Data Process</guimenu>
      <guisubmenu>Grains</guisubmenu>
      <guimenuitem>Mark by Otsu's</guimenuitem>
    </menuchoice>.
    This method classifies the data values into two classes, minimising the
    intra-class variances within both.  It is most suitable for images that
    contain two relatively well defined value levels.
  </para>
  <para id='grain-edge'>
    <indexterm>
      <primary>grain marking</primary>
      <secondary>edge-based</secondary>
    </indexterm>
    Another grain marking function,
    <menuchoice>
      <guimenu>Data Process</guimenu>
      <guisubmenu>Grains</guisubmenu>
      <guimenuitem>Mark by Edge Detection</guimenuitem>
    </menuchoice>,
    is based on edge detection (local curvature).  The image is processed with
    a difference-of-Gaussians filter of a given size and thresholding is then
    performed on this filtered image instead of the original.
  </para>
  <para id='grain-remove-touching-edges'>
    Grains that touch image eges can be removed using
    <menuchoice>
      <guimenu>Data Process</guimenu>
      <guisubmenu>Grains</guisubmenu>
      <guimenuitem>Remove Edge-Touching</guimenuitem>
    </menuchoice> menu choice.
    This is useful if such grains are considered incomplete and must be
    excluded from analysis.  Several other other functions that may be useful
    for modification of grain shapes after marking are performed by the
    <link linkend='mask-editor'>Mask Editor</link> tool.
  </para>
  <sect2 id='grain-watershed'>
    <title>
      Watershed
      <guiicon>
        <inlinemediaobject>
          <imageobject>
            <imagedata fileref='gwy_grains_water-24.png' format='PNG'/>
          </imageobject>
        </inlinemediaobject>
      </guiicon>
    </title>
    <indexterm>
      <primary>grain marking</primary>
      <secondary>watershed</secondary>
    </indexterm>
    <para>
      For more complicated data structures the effectiveness of thresholding
      algorithms can be very poor. For these data a <emphasis>watershed
        algorithm</emphasis> can be used more effectively for grain or particle
      marking.
    </para>
    <para>
      The watershed algorithm is usually employed for local minima
      determination and image segmentation in image processing. As the problem
      of determining the grain positions can be understood as the problem of
      finding local extremes on the surface this algorithm can be used also for
      purposes of grain segmentation or marking. For convenience in the
      following we will treat the data inverted in the
      <xi:include href="eqi-z.xml"/> direction while describing the algorithm
      (i.e. the grain tops are forming local minima in the following text). We
      applied two stages of the grain analysis
      (see [<link linkend='grain-analysis-ref-1'>1</link>]):
    </para>
    <orderedlist>
      <listitem>
        Grain location phase: At each point of the inverted surface the virtual water drop was
        placed (amount of water is controlled by parameter <guilabel>Drop size</guilabel>). In the case that the drop was not already in a local minimum it
        followed the steepest descent path to minimize its potential energy. As
        soon as the drop reached any local minimum it stopped here and rested
        on the surface. In this way it filled the local minimum partially by
        its volume (see figure below and its caption). This process was
        repeated several times (parameter <guilabel>Number of steps</guilabel>). As the result a system of lakes of different
        sizes filling the inverted surface depressions was obtained. Then the
        area of each of the lakes was evaluated and the smallest lakes are
        removed under assumption that they were formed in the local minima
        originated by noise (all lakes smaller than parameter <guilabel>Threshold</guilabel> are removed). The larger lakes were used to identify the
        positions of the grains for segmentation in the next step. In this way the noise in the AFM data was
        eliminated. As a result 
      </listitem>
      <listitem>
        Segmentation phase: The grains found in the step 1 were marked (each one by a different
        number). The water drops continued in falling to the surface and
        filling the local minima (amount of water is controlled by parameter <guilabel>Drop size</guilabel>). 
        Total number of steps of sphlashing a drop at every surface position is controlled by parameter <guilabel>Number of steps</guilabel>. 
        As the grains were already identified and
        marked after the first step, the next five situations could happen as
        soon as the drop reached a local minimum.
        <orderedlist>
          <listitem>
            The drop reached the place previously marked as a concrete grain.
            In this case the drop was merged with the grain, i. e. it was
            marked as a part of the same grain.
          </listitem>
          <listitem>
            The drop reached the place where no grain was found but a concrete
            grain was found in the closest neighbourhood of the drop. In this
            case the drop was merged with the grain again.
          </listitem>
          <listitem>
            The drop reached the place where no grain was found and no grain
            was found even in the closest neighbourhood of the drop. In that
            case the drop was not marked at all.
          </listitem>
          <listitem>
            The drop reached the place where no grain was found but more than
            one concrete grain was found in the closest neighbourhood (e. g.
            two different grains were found in the neighbourhood). In this case
            the drop was marked as the grain boundary.
          </listitem>
          <listitem>
            The drop reached the place marked as grain boundary. In this case
            the drop was marked as the grain boundary too.
          </listitem>
        </orderedlist>
      </listitem>
    </orderedlist>
    <para>
      In this way we can identify the grain positions and then determine the
      volume occupied by each grain separately. If features of interest are valleys rather than
      grains (hills), 
      parameter <guilabel>Invert height</guilabel> can be used.
    </para>
    <informalfigure id='fig-grain-marking'>
      <mediaobject>
        <imageobject>
          <imagedata fileref='allgrains.png' format='PNG'/>
        </imageobject>
        <caption>
          Image of grain-like surface structure (a) and corresponding results
          of height thresholding (b), curvature thresholding (c), and
          watershed (d) algorithm.   Within watershed algorithm it is possible
          to segment image even further.
        </caption>
      </mediaobject>
    </informalfigure>
  </sect2>
  <sect2 id='grain-analysis-statistics'>
    <title>Statistics</title>
    <indexterm><primary>number of grains</primary></indexterm>
    <para>
      Grain properties can be studied using several functions. The simplest of
      them is Grain Statistics
    </para>
    <sect3 id='grain-statistics'>
      <title>Grain Statistics</title>
      <para>
        <menuchoice>
          <guimenu>Data Process</guimenu>
          <guisubmenu>Grains</guisubmenu>
          <guimenuitem>Statistics</guimenuitem>
        </menuchoice>
      </para>
      <para>
        This function calculates the total number of marked grains, their total
        projected area, both as an absolute value and as a fraction of total
        data field area, total grain volumes, total length of grain boundaries
        and the mean area and equivalent square size of one grain.  The mean
        size is calculated by averaging the equivalent square sides so its
        square is not, in general, equal to the mean area.
      </para>
      <para>
        Overall characteristics of the marked area can be also obtained with
        Statistical Quantities tool when its <guilabel>Use mask</guilabel>
        option is switched on.  By inverting the mask the same information
        can be obtained also for the non-grain area.
      </para>
    </sect3>
    <sect3 id='grain-distributions'>
      <title>
        Grain Distributions
        <guiicon>
          <inlinemediaobject>
            <imageobject>
              <imagedata fileref='gwy_grains_graph-24.png' format='PNG'/>
            </imageobject>
          </inlinemediaobject>
        </guiicon>
      </title>
      <para>
        <menuchoice>
          <guimenu>Data Process</guimenu>
          <guisubmenu>Grains</guisubmenu>
          <guimenuitem>Distributions</guimenuitem>
        </menuchoice>
      </para>
      <para>
        Grain Distributions is the most powerful and complex tool. It has two
        basic modes of operation: graph plotting and raw data export. In
        graph plotting mode selected characteristics of individual grains are
        calculated, gathered and summary graphs showing their distributions
        are plotted.
      </para>
      <para>
        Raw data export is useful for experts who need for example to
        correlate properties of individual grains.  In this mode selected
        grain characteristics are calculated and dumped to a text file table
        where each row corresponds to one grain and columns correspond to
        requested quantities.  The order of the colums is the same as the
        relative order of the quantities in the dialog; all values are
        written in base SI units, as is usual in
        <application>Gwyddion</application>.
      </para>
    </sect3>
    <sect3 id='grain-correlation'>
      <title>
        Grain Property Correlation
      </title>
      <para>
        <menuchoice>
          <guimenu>Data Process</guimenu>
          <guisubmenu>Grains</guisubmenu>
          <guimenuitem>Correlate</guimenuitem>
        </menuchoice>
      </para>
      <para>
        Grain correlation plots a graph of one selected graph quantity as
        the function of another grain quantity, visualizing correlations
        between them.
      </para>
    </sect3>
    <sect3 id='grain-measure'>
      <title>
        Grain Measurement Tool
        <guiicon>
          <inlinemediaobject>
            <imageobject>
              <imagedata fileref='gwy_grains_measure-24.png' format='PNG'/>
            </imageobject>
          </inlinemediaobject>
        </guiicon>
      </title>
      <para>
        The grain measurement tool is the interactive method to obtain the
        same information about individual grains as
        <link linkend='grain-distributions'>Grain Distributions</link> in raw
        mode.  After selecting a grain on the data window with mouse, all
        the available quantities are displayed in the tool window.
      </para>
      <para>
        Beside physical characteristics this tool also displays the grain
        number.  Grain numbers corresponds to row numbers (counting from 1)
        in files exported by
        <link linkend='grain-distributions'>Grain Distributions</link>.
      </para>
    </sect3>
  </sect2>
  <sect2 id='grain-properties'>
    <title>Grain Properties</title>
    <para>
      <link linkend='grain-distributions'>Grain Distributions</link>
      and <link linkend='grain-measure'>Grain measurement tool</link>
      can calculate the following grain properties:
    </para>
    <variablelist>
      <varlistentry>
        <term>Value-related properties</term>
        <listitem>
          <itemizedlist>
            <listitem>
              <indexterm>
                <primary>minimum</primary>
                <secondary>of a grain</secondary>
              </indexterm>
              <guilabel>Minimum</guilabel>,
              the minimum value (height) occuring inside the grain.
            </listitem>
            <listitem>
              <indexterm>
                <primary>maximum</primary>
                <secondary>of a grain</secondary>
              </indexterm>
              <guilabel>Maximum</guilabel>,
              the maximum value (height) occuring inside the grain.
            </listitem>
            <listitem>
              <indexterm>
                <primary>mean</primary>
                <secondary>of a grain</secondary>
              </indexterm>
              <guilabel>Mean</guilabel>,
              the mean of all values occuring inside the grain, that is the
              mean grain height.
            </listitem>
            <listitem>
              <indexterm>
                <primary>median</primary>
                <secondary>of a grain</secondary>
              </indexterm>
              <guilabel>Median</guilabel>
              the median of all values occuring inside the grain, that is the
              median grain height.
            </listitem>
            <listitem>
              <indexterm>
                <primary>minimum</primary>
                <secondary>on a grain boundary</secondary>
              </indexterm>
              <guilabel>Minimum on boundary</guilabel>,
              the minimum value (height) occuring on the inner grain boundary.
              This means within the set of pixels that lie inside the grain
              but at least one of their neighbours lies outside.
            </listitem>
            <listitem>
              <indexterm>
                <primary>maximum</primary>
                <secondary>on a grain boundary</secondary>
              </indexterm>
              <guilabel>Maximum on boundary</guilabel>,
              the maximum value (height) occuring on the inner grain boundary,
              defined similarly to the minimum.
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Area-related properties</term>
        <listitem>
          <itemizedlist>
            <listitem>
              <guilabel>Projected area</guilabel>,
              the projected (flat) area of the grain.
            </listitem>
            <listitem>
              <guilabel>Equivalent square side</guilabel>,
              the side of the square with the same projected area as the
              grain.
            </listitem>
            <listitem>
              <guilabel>Equivalent disc radius</guilabel>,
              the radius of the disc with the same projected area as the
              grain.
            </listitem>
            <listitem>
              <guilabel>Surface area</guilabel>,
              the surface area of the grain, see
              <link linkend='surface-area-calculation'>statistical
                quantities</link> section for description of the surface area
              estimation method.
            </listitem>
            <listitem>
              <guilabel>Area of convex hull</guilabel>,
              the projected area of grain convex hull.  The convex hull area is
              slightly larger than the grain area even for grains that appear
              to be fairly convex due to pixelization of the mask.  The only
              grains with exactly the same area as their convex hulls are
              perfectly rectangular grains.
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Boundary-related properties</term>
        <listitem>
          <itemizedlist>
            <listitem>
              <guilabel>Projected boundary length</guilabel>,
              the length of the grain boundary projected to the horizontal
              plane (that is not taken on the real three-dimensional
              surface).  The method of boundary length estimation is
              described below.
            </listitem>
            <listitem>
              <guilabel>Minimum bounding size</guilabel>,
              the minimum dimension of the grain in the horizontal plane.  It
              can be visualized as the minimum width of a gap in the
              horizontal plane the grain could pass through.
            </listitem>
            <listitem>
              <guilabel>Minimum bounding direction</guilabel>,
              the direction of the gap from the previous item.  If the grain
              exhibits a symmetry that makes several directions to qualify,
              an arbitrary direction is chosen.
            </listitem>
            <listitem>
              <guilabel>Maximum bounding size</guilabel>,
              the maximum dimension of the grain in the horizontal plane.  It
              can be visualized as the maximum width of a gap in the
              horizontal plane the grain could fill up.
            </listitem>
            <listitem>
              <guilabel>Maximum bounding direction</guilabel>,
              the direction of the gap from the previous item.  If the grain
              exhibits a symmetry that makes several directions to qualify,
              an arbitrary direction is chosen.
            </listitem>
            <listitem>
              <guilabel>Maximum inscribed disc radius</guilabel>,
              the radius of maximum disc that fits inside the grain.
              The entire full disc must fit, not just its boundary circle,
              which matters for grains with voids within.  You can use
              <link linkend='tool-mask-editor'>Mask Editor tool</link> to
              fill voids in grains to get rid of voids.
            </listitem>
            <listitem>
              <guilabel>Maximum inscribed disc center x position</guilabel>,
              the horizontal coordinate of center of the maximum inscribed
              disc.  More precisely, of one such disc if it is not unique.
            </listitem>
            <listitem>
              <guilabel>Maximum inscribed disc center y position</guilabel>,
              the vertical coordinate of center of the maximum inscribed
              disc.  More precisely, of one such disc if it is not unique but
              of the same as in the previous item.
            </listitem>
            <listitem>
              <guilabel>Minimum circumcircle radius</guilabel>,
              the radius of minimum circle that contains the grain.
            </listitem>
            <listitem>
              <guilabel>Minimum circumcircle center x position</guilabel>,
              the horizontal coordinate of center of the minimum
              circumcircle.
            </listitem>
            <listitem>
              <guilabel>Minimum circumcircle center y position</guilabel>,
              the vertical coordinate of center of the minimum
              circumcircle.
            </listitem>
            <listitem>
              <guilabel>Mean radius</guilabel>,
              the mean distance from grain center of mass to its boundary.
              This quantity is mostly meaningful only for convex or
              nearly-convex grains.
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Volume-related properties</term>
        <listitem>
          <itemizedlist>
            <listitem>
              <guilabel>Zero basis</guilabel>,
              the volume between grain surface and the plane
              <xi:include href="eqi-z-is-0.xml"/>.
              Values below zero form negative volumes.  The zero level must be
              set to a reasonable value (often
              <link linkend='fix-zero'>Fix Zero</link> is sufficient) for
              the results to make sense, which is also the advantage of
              this method: one can use basis plane of his choice.
            </listitem>
            <listitem>
              <guilabel>Grain minimum basis</guilabel>,
              the volume between grain surface and the plane
              <xi:include href="eqi-z-is-z_min.xml"/>, where
              <xi:include href="eqi-z_min.xml"/> is the minimum value (height)
              occuring in the grain.  This method accounts for grain
              surrounding but it typically underestimates the volume,
              especially for small grains.
            </listitem>
            <listitem>
              <guilabel>Laplacian backround basis</guilabel>,
              the volume between grain surface and the basis surface formed
              by laplacian interpolation of surrounding values.  In other
              words, this is the volume that would disappear after using
              <link linkend='remove-data-under-mask'>Remove Data Under Mask</link>
              or
              <link linkend='tool-remove-grains'>Grain Remover</link> tool
              with Laplacian interpolation on the grain.  This is the most
              sophisticated method, on the other hand it is the hardest to
              develop intuition for.
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Position-related properties</term>
        <listitem>
          <itemizedlist>
            <listitem>
              <guilabel>Center x position</guilabel>,
              the horizontal coordinate of the grain center.  Since the
              grain area is defined as the area covered by the
              corresponding mask pixels, the center of a single-pixel grain
              has half-integer coordinates, not integer ones.  Data field
              origin offset (if any) is taken into account.
            </listitem>
            <listitem>
              <guilabel>Center y position</guilabel>,
              the vertical coordinate of the grain center.  See above for
              the interpretation.
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Slope-related properties</term>
        <listitem>
          <itemizedlist>
            <listitem>
              <guilabel>Inclination θ</guilabel>,
              the deviation of the normal to the mean plane from the
              <xi:include href="eqi-z.xml"/>-axis,
              see <link linkend='inclinations-coordinates'>inclinations</link>
              for details.
            </listitem>
            <listitem>
              <guilabel>Inclination φ</guilabel>,
              the azimuth of the slope, as defined in
              <link linkend='inclinations-coordinates'>inclinations</link>.
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Curvature-related properties</term>
        <listitem>
          <itemizedlist>
            <listitem>
              <guilabel>Curvature center <xi:include href="eqi-x.xml"/></guilabel>,
              the horizontal position of the center of the quadratic surface
              fitted to the grain surface.
            </listitem>
            <listitem>
              <guilabel>Curvature center <xi:include href="eqi-y.xml"/></guilabel>,
              the vertical position of the center of the quadratic surface
              fitted to the grain surface.
            </listitem>
            <listitem>
              <guilabel>Curvature center <xi:include href="eqi-z.xml"/></guilabel>,
              the value at the center of the quadratic surface fitted to the
              grain surface.  Note this is the value at the fitted surface,
              not at the real grain surface.
            </listitem>
            <listitem>
              <guilabel>Curvature 1</guilabel>,
              the smaller curvature (i.e. the inverse of the curvature radius)
              at the center.
            </listitem>
            <listitem>
              <guilabel>Curvature 2</guilabel>,
              the larger curvature (i.e. the inverse of the curvature radius)
              at the center.
            </listitem>
            <listitem>
              <guilabel>Curvature angle 1</guilabel>,
              the direction corresponding to <guilabel>Curvature 1</guilabel>.
            </listitem>
            <listitem>
              <guilabel>Curvature angle 2</guilabel>,
              the direction corresponding to <guilabel>Curvature 2</guilabel>.
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Moment-related properties</term>
        <listitem>
          <itemizedlist>
            <listitem>
              <guilabel>Major semiaxis of equivalent ellipse</guilabel>,
              the length of the major semiaxis of an ellipse which has the
              same second order moments in the horizontal plane.
            </listitem>
          </itemizedlist>
          <itemizedlist>
            <listitem>
              <guilabel>Minor semiaxis of equivalent ellipse</guilabel>,
              the length of the minor semiaxis of an ellipse which has the
              same second order moments in the horizontal plane.
            </listitem>
          </itemizedlist>
          <itemizedlist>
            <listitem>
              <guilabel>Orientation of equivalent ellipse</guilabel>,
              the direction of the major semiaxis of an ellipse which has the
              same second order moments in the horizontal plane.  For
              a circular grain, the angle is set to zero by definition.
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
    </variablelist>
    <informalfigure id='fig-grain-bounding-dims'>
      <mediaobject>
        <imageobject>
          <imagedata fileref='grain-bounding-dims.pdf' format='PDF'/>
        </imageobject>
        <imageobject>
          <imagedata fileref='grain-bounding-dims.png' format='PNG'/>
        </imageobject>
        <caption>
          Maximum and minimum bounding dimensions and angles of a grain.
        </caption>
      </mediaobject>
    </informalfigure>
    <para id='boundary-length-calculation'>
      <indexterm><primary>boundary length calculation</primary></indexterm>
      The grain boundary length is estimated by summing estimated contributions
      of each four-pixel configuration on the boundary.  The contributions
      are displayed on the following figure for each type of configuration,
      where <xi:include href="eqi-h_x.xml"/> and
      <xi:include href="eqi-h_y.xml"/> are pixel dimension along corresponding
      axes and <xi:include href="eqi-h.xml"/> is the length of the pixel
      diagonal:
      <xi:include href="eq-grain-boundary-pixel-diagonal.xml"/>
      The contributions correspond one-to-one to lengths of segments of the
      boundary of a polygon approximating the grain shape.  The construction of
      the equivalent polygonal shape can also be seen in the figure.
    </para>
    <informalfigure id='fig-boundary-length'>
      <mediaobject>
        <imageobject>
          <imagedata fileref='boundary-length.pdf' format='PDF'/>
        </imageobject>
        <imageobject>
          <imagedata fileref='boundary-length.png' format='PNG'/>
        </imageobject>
        <caption>
          Contributions of pixel configurations to the estimated boundary
          length (top).  Grey squares represent pixels inside the grain, white
          squares represent outside pixels.  The estimated contribution of each
          configuration is:
          (a) <xi:include href="eqi-h-over-2.xml"/>,
          (b1), (b2) <xi:include href="eqi-h.xml"/>,
          (c) <xi:include href="eqi-h_y.xml"/>,
          (d) <xi:include href="eqi-h_x.xml"/>,
          (e) <xi:include href="eqi-h-over-2.xml"/>.
          Cases (b1) and (b2) differ only in the visualization of the
          polygonal shape segments, the estimated boundary lengths are
          identical.  The bottom part of the figure illustrates how the
          segments join to form the polygon.
        </caption>
      </mediaobject>
    </informalfigure>
    <para id='grain-volume-calculation'>
      <indexterm><primary>volume calculation</primary></indexterm>
      The grain volume is, after subtracting the basis, estimated as the
      volume of exactly the same body whose upper surface is used for
      <link linkend='fig-surface-area-vertices'>surface area calculation</link>.
      Note for the volume between vertices this is equivalent to the classic
      two-dimensional trapezoid integration method.  However, we calculate the
      volume under a mask centered on vertices, therefore their contribution
      to the integral is distributed differently as shown in the following
      figure.
    </para>
    <informalfigure id='fig-volume-pixel-weights'>
      <mediaobject>
        <imageobject>
          <imagedata fileref='volume-pixel-weights.pdf' format='PDF'/>
        </imageobject>
        <imageobject>
          <imagedata fileref='volume-pixel-weights.png' format='PNG'/>
        </imageobject>
        <caption>
          Contributions of individual pixels to the volume of single pixel
          (grey).
        </caption>
      </mediaobject>
    </informalfigure>
    <para>
      Curvature-related properties of individual grains are calculated
      identically to the global curvature calculated by
      <link linkend='curvature'>Curvature</link>.  See its description for
      some discussion.
    </para>
    <informalfigure id='fig-grain-inscribed-exscribed'>
      <mediaobject>
        <imageobject>
          <imagedata fileref='grain-inscribed-exscribed.pdf' format='PDF'/>
        </imageobject>
        <imageobject>
          <imagedata fileref='grain-inscribed-exscribed.png' format='PNG'/>
        </imageobject>
        <caption>
          Maximum inscribed disc and minimum circumcircle of a grain.
        </caption>
      </mediaobject>
    </informalfigure>
    <para>
      Inscribed discs and circumcircles of grains can be visualized using
      <menuchoice>
        <guimenu>Data Process</guimenu>
        <guisubmenu>Grains</guisubmenu>
        <guimenuitem>Select Inscribed Discs</guimenuitem>
      </menuchoice>
      and
      <menuchoice>
        <guimenu>Data Process</guimenu>
        <guisubmenu>Grains</guisubmenu>
        <guimenuitem>Select Exscribed Circles</guimenuitem>
      </menuchoice>.
      These functions create circular selections representing the
      corresponding disc or circle for each grain that can be subsequently
      displayed using <link linkend='tool-selection-manager'>Selection
      Manager tool</link>.
    </para>
  </sect2>
  <sect2 id='grain-filter'>
    <title>
      Grain Filtering
      <guiicon>
        <inlinemediaobject>
          <imageobject>
            <imagedata fileref='gwy_grains_remove-24.png' format='PNG'/>
          </imageobject>
        </inlinemediaobject>
      </guiicon>
    </title>
    <para>
      Marked grains can be filtered by thresholding by any of the
      available grain quantities using
      <menuchoice>
        <guimenu>Data Process</guimenu>
        <guisubmenu>Grains</guisubmenu>
        <guimenuitem>Filter</guimenuitem>
      </menuchoice> menu choice.
      The module can be used for basic operations, such as removal of tiny
      grains using a pixel area threshold, as well as complex filtering using
      logical expressions involving several grain quantitities.
    </para>
    <para>
      The filter retains grains that satisfy the condition specified as
      <guilabel>Keep grains satisfying</guilabel> and removes all other
      grains.  The condition is expressed as a logical expression of one to
      three individual thresholding conditions, denoted <varname>A</varname>,
      <varname>B</varname> and <varname>C</varname>. The simplest expression
      is just <varname>A</varname>, stating that quantity
      <varname>A</varname> must lie within given thresholds.
    </para>
    <para>
      Each condition consits of lower and upper thresholds for one grain
      quantity, for instance pixel area or minimum value.  The values must
      lie within the interval [lower,upper] to satisfy the condition and thus
      retain the grains.  Note it is possible to choose the lower threshold
      larger than the upper threshold.  In this case the condition is
      inverted, i.e. the grain is retained if the value lies outside
      [upper,lower].
    </para>
    <para>
      Individual grain quantities are assigned to <varname>A</varname>,
      <varname>B</varname> and <varname>C</varname> by selecting the
      quantity in the list and clicking on the corresponding button in
      <guilabel>Set selected as</guilabel>.  The currently selected set of
      quantities is displayed in the
      <guilabel>Condition A</guilabel>,
      <guilabel>Condition B</guilabel> and
      <guilabel>Condition C</guilabel> headers.
    </para>
  </sect2>
  <sect2 id='grain-level'>
    <title>Grain Leveling</title>
    <indexterm><primary>grain leveling</primary></indexterm>
    <para>
      Grains can be aligned vertically using
      <menuchoice>
        <guimenu>Data Process</guimenu>
        <guisubmenu>Grains</guisubmenu>
        <guimenuitem>Level Grains</guimenuitem>
      </menuchoice>.
      This function vertically shifts each grain to make a certain
      height-related quantity of all grains equal.  Typically, the grain
      minimum values are aligned but other choices are possible.
    </para>
    <para>
      Data between grains are also vertically shifted.  The shifts are
      interpolated from the grain shifts using the Laplace equation, leading
      to a smooth transition of the shifts between the grains (though with no
      regard to other possible surface features).
    </para>
  </sect2>
  <sect2 id='grain-edt'>
    <title>Euclidean Distance Transform</title>
    <indexterm><primary>distance transform</primary></indexterm>
    <para>
      The Euclidean distance transform assigns to each pixel its distance to
      the grain (mask) boundary.  It is, in a certain sense, complementary to
      the watershed.
    </para>
    <para>
      If it is applied to grain interiors the distance is zero outside grains
      and increases towards the grain ‘centres’.  Conversely, it can be
      applied to the exteriors and it is then highest for pixels farthest
      from any grain.  It is also possible to calculate signed two-side
      transform which is the difference of the two transforms, i.e. it is
      positive inside grains and negative outside.
    </para>
    <para>
      Option <guilabel>Shrink from border</guilabel> controls the handling of
      borders.  When it is enabled, image boundaries are considerd to be
      also grain (or non-grain) boundaries.  Pixels on the image edge thus
      cannot receive large values.  When it is disabled, the grains (or
      non-grains) are effectively infinitely large outside the image.
      So pixels close to the boundary can receive large distance values.
    </para>
  </sect2>
  <sect2 id='grain-analysis-ref'>
    <title>References</title>
    <para id='grain-analysis-ref-1'>
      [1] <ulink url='http://klapetek.cz/download.html'>
        Petr Klapetek, Ivan Ohlídal, Daniel Franta, Alberto Montaigne-Ramil, Alberta Bonanni, David Stifter, Helmut Sitter:
        Acta Physica Slovaca, 3 (223-230), 2003
      </ulink>
    </para>
  </sect2>
  <!--  Doesn't work well, needs serious formatting improvements.
  <bibliography>
    <biblioentry>
      <biblioset relation='article'>
        <authorgroup>
          <author><firstname>Petr</firstname><surname>Klapetek</surname></author>
          <author><firstname>Ivan</firstname><surname>Ohlídal</surname></author>
          <author><firstname>Daniel</firstname><surname>Franta</surname></author>
          <author><firstname>Alberto</firstname><surname>Montaigne-Ramil</surname></author>
          <author><firstname>Alberta</firstname><surname>Bonanni</surname></author>
          <author><firstname>David</firstname><surname>Stifter</surname></author>
          <author><firstname>Helmut</firstname><surname>Stifter</surname></author>
        </authorgroup>
        <title>Atomic force microscopy characterization of ZnTe epitaxial films</title>
      </biblioset>
      <biblioset relation='journal'>
        <title>Acta Physica Slovaca</title>
        <volumenum>3</volumenum>
        <pagenums>223-230</pagenums>
        <pubdate>2003</pubdate>
      </biblioset>
    </biblioentry>
  </bibliography>
  -->
</sect1>
<!-- vim: set ts=2 sw=2 et : -->
