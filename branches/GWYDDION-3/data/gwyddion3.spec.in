# $Id: Makefile.am 11706 2011-01-03 08:37:05Z yeti-dn $
%{expand:%global distro_is_redhat %(test ! -f /etc/redhat-release; echo $?)}
%{expand:%global distro_is_suse %(test ! -f /etc/SuSE-release; echo $?)}

Name:          gwyddion3
Version:       @PACKAGE_VERSION@
Release:       1
Summary:       An SPM data visualization and analysis tool

Group:         Applications/Engineering
License:       GNU GPL
URL:           http://gwyddion.net/
Source0:       http://downloads.sourceforge.net/@PACKAGE_TARNAME@/@PACKAGE_TARNAME@-%{version}.tar.xz
Requires(pre):    /sbin/ldconfig
Requires(postun): /sbin/ldconfig

BuildRequires: glib2-devel >= 2.26
BuildRequires: gdk-pixbuf2-devel >= 2.22
BuildRequires: gtk3-devel >= 3.0
BuildRequires: intltool >= 0.40
# XXX: In fact, we need a yet-unreleased fixed to get plain old data docs right.
BuildRequires: gtk-doc >= 1.17
BuildRequires: gettext >= 0.17
BuildRequires: gobject-introspection-devel >= 0.10.0
BuildRequires: pkgconfig >= 0.22
BuildRequires: python >= 2.2
BuildRequires: findutils
# XXX: For make check.
BuildRequires: elfutils

%if %{distro_is_redhat}
%global fftw3 fftw
%global fftw3devel fftw-devel
%endif

%if %{distro_is_suse}
%global fftw3 fftw3
%global fftw3devel fftw3-devel
%endif

# Default the fftw package name to the common name in the hope the distro
# provides that.  The expansion inside %if is somehow limited, define the
# test in two steps.
%global fftwundefined %{?fftw3:0}%{!?fftw3:1}
%if %{fftwundefined}
%global fftw3 fftw
%global fftw3devel fftw-devel
%endif

BuildRequires: %{fftw3devel} >= 3.1

%global pkglibdir %{_libdir}/%{name}
%global pkglibexecdir %{_libexecdir}/%{name}
%global pkgdatadir %{_datadir}/%{name}
%global pkgincludedir %{_includedir}/%{name}
%global gtkdocdir %{_datadir}/gtk-doc/html
%global vimdir %{_datadir}/vim/vimfiles
%global pkgconfigdir %{_libdir}/pkgconfig
%global girdir %{_datadir}/gir-1.0
%global typelibdir %{_libdir}/girepository-1.0


%package libs
Summary:       Gwyddion3 libraries
Group:         System Environment/Libraries

%package libs-devel
Summary:       Development files for Gwyddion3
Group:         Development/Libraries
Requires:      %{name}-libs%{?_isa} = %{version}-%{release}
# This pulls everything else
Requires:      gtk3-devel >= 3.0


%description
Gwyddion is a modular SPM (Scanning Probe Microsopy) data visualization and
analysis tool written with Gtk+.

This is a dummy package as no Gwyddion 3 application actually exists yet.


%description libs
Gwyddion3 data processing and visualisation libraries.


%description libs-devel
Header files, libraries and tools for development of Gwyddion3 modules and/or
Gwyddion3-based applications.  This package also contains the API docmentation.


%prep
%setup -q -n @PACKAGE_TARNAME@-@PACKAGE_VERSION@
# Don't install .la files.
sed -i -e '/# Install the pseudo-library/,/^$/d' build/ltmain.sh


%build
%configure --disable-rpath --enable-gtk-doc --enable-introspection
make %{?_smp_mflags}


%install
rm -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT
install -D data/%{name}.vim $RPM_BUILD_ROOT/%{vimdir}/syntax/%{name}.vim
# TODO: Once we have more translations, add them
%find_lang %{name}-libgwy
find $RPM_BUILD_ROOT -name '*.la' -delete


%post libs -p /sbin/ldconfig


%postun libs -p /sbin/ldconfig


%files
%defattr(644,root,root)
%doc AUTHORS COPYING INSTALL.gwyddion NEWS README


%files libs -f %{name}-libgwy.lang
%defattr(-,root,root)
# For unstable releases
%{_libdir}/libgwy3-@PACKAGE_VERSION@.so
%{_libdir}/libgwyui3-@PACKAGE_VERSION@.so
#%{_libdir}/libgwy3.so.*
#%{_libdir}/libgwyui3.so.*
%{typelibdir}/Gwy3-3.0.typelib
%{typelibdir}/GwyUI3-3.0.typelib


%files libs-devel
%defattr(-,root,root)
%{vimdir}/syntax/%{name}.vim
%{pkgincludedir}/libgwy/*.h
%{pkgincludedir}/libgwyui/*.h
%{pkgincludedir}/*.h
%dir %{pkgincludedir}/libgwy
%dir %{pkgincludedir}/libgwyui
%dir %{pkgincludedir}
%{_libdir}/libgwy3.so
%{_libdir}/libgwyui3.so
%{girdir}/Gwy3-3.0.gir
%{girdir}/GwyUI3-3.0.gir
%{pkgconfigdir}/libgwy3.pc
%{pkgconfigdir}/libgwyui3.pc
%doc %{gtkdocdir}/libgwy/*
%doc %{gtkdocdir}/libgwyui/*
%doc %dir %{gtkdocdir}/libgwy
%doc %dir %{gtkdocdir}/libgwyui
