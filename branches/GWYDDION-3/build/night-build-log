#!/bin/bash
# @(#) $Id$
pkgname=gwyddion
projectdir=$PWD
logdir=$projectdir/_logs
tmplog=$logdir/tmplog
libdirs="libgwy"
podirs="po po-libgwy"

source $HOME/.bashrc
export LC_ALL=C
PATH="$HOME/bin:$PATH"
cd $logdir || exit 1

cat >autogen.ignore <<':'
^aclocal: installing `m4/pkg\.m4' from `/usr/share/aclocal/pkg\.m4'
^configure\.ac:[0-9]+: installing `build/[-a-z.]+'
^Makefile\.am: installing `\./INSTALL'
^lib[a-z]*/Makefile\.am: installing `build/depcomp'
':'
:

cat >build_documentation.ignore <<':'
^Writing .* for [^ ]+\(.*\)
^Computing chunks\.\.\.
^.*: warning: no link for: 'gwy-foo
':'
:

cat >distcheck.ignore <<':'
^Writing .* for [^ ]+\(.*\)
^libtool: install: warning: remember to run `libtool --finish /home/yeti/Projects/Gwyddion/GWYDDION-3-HEAD/gwyddion-[0-9.]+/_inst/lib'$
':'
:

function printerr() {
  f=$1
  shift

  test -s $f.err || return
  cat --squeeze-blank $f.err \
  | {
    # Exclude errors matching a list of regexps
    if test -s $f.ignore; then
      grep -Evf $f.ignore
    else
      cat
    fi
  } | {
    # Exclude literal errors, typically those from other part of the build
    if test -n "$1"; then
      grep -Fvf "$1"
    else
      cat
    fi
  } >$tmplog
  test -s $tmplog || return
  echo "=====[ $f ]====="
  cat $tmplog
}

function extract_build_documentation() {
  logfile=build_documentation.err
  grep -Evf build_documentation.ignore <$logfile >$tmplog
  logfile=build_documentation.log
  grep -E '\<(warning|error):' <$logfile \
    | grep -Evf build_documentation.ignore >>$tmplog
  if test -s $tmplog -a -z "$h"; then
    echo "=====[ build_documentation ]====="
  fi
  cat $tmplog
}

function extract_documentation_stats() {
  logfile=build_documentation.log
  htmlfile=documentation-stats.html
  logs=$(echo "$libdirs" | sed -r "s:[a-z0-9]+:$projectdir/docs/\\0/\\0-undocumented.txt:g")
  $projectdir/build/documentation-stats.py $logs >$htmlfile
  cp $logs $logdir
}

function extract_translation_stats() {
   #logfile=update_translations.err
   #htmlfile=translation-stats.html
   #$projectdir/build/translation-stats.py <$logfile >$htmlfile
   :
}

function extract_coverage_stats() {
  for dir in $libdirs; do
    mv -f $projectdir/$dir/test-report-$dir.html .
    sed -rn '/<table/,/<\/table>/p' $projectdir/$dir/coverage/coverage.html \
      >coverage-$dir.html
  done
}

cat build.err make_dists.err build_documentation.err install.err >all.err
printerr set_extra_version
printerr autogen
printerr build
extract_build_documentation
printerr update_translations
printerr check_debug
printerr check_headers
printerr check_symbols
printerr install build.err
printerr make_dists build.err
printerr build_rpm build.err
printerr distcheck all.err
extract_translation_stats
extract_documentation_stats
extract_coverage_stats

rm -f *.ignore $tmplog
